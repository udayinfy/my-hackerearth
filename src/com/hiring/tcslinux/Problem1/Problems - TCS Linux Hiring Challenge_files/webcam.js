// WebcamJS v1.0.22
// Webcam library for capturing JPEG/PNG images in JavaScript
// Attempts getUserMedia, falls back to Flash
// Author: Joseph Huckaby: http://github.com/jhuckaby
// Based on JPEGCam: http://code.google.com/p/jpegcam/
// Copyright (c) 2012 - 2017 Joseph Huckaby
// Licensed under the MIT License
(function(a){function c(){var a=Error.apply(this,arguments);a.name=this.name="FlashError",this.stack=a.stack,this.message=a.message}function d(){var a=Error.apply(this,arguments);a.name=this.name="WebcamError",this.stack=a.stack,this.message=a.message}var b;IntermediateInheritor=function(){},IntermediateInheritor.prototype=Error.prototype,c.prototype=new IntermediateInheritor,d.prototype=new IntermediateInheritor;var e={version:"1.0.22",protocol:location.protocol.match(/https/i)?"https":"http",loaded:!1,live:!1,userMedia:!0,iOS:/iPad|iPhone|iPod/.test(navigator.userAgent)&&!a.MSStream,params:{width:0,height:0,dest_width:0,dest_height:0,image_format:"jpeg",jpeg_quality:90,enable_flash:!0,force_flash:!1,flip_horiz:!1,fps:30,upload_name:"webcam",constraints:null,swfURL:"",flashNotDetectedText:"ERROR: No Adobe Flash Player detected.  Webcam.js relies on Flash for browsers that do not support getUserMedia (like yours).",noInterfaceFoundText:"No supported webcam interface found.",unfreeze_snap:!0,iosPlaceholderText:"Click here to open camera.",user_callback:null,user_canvas:null},errors:{FlashError:c,WebcamError:d},hooks:{},init:function(){var b=this;this.mediaDevices=navigator.mediaDevices&&navigator.mediaDevices.getUserMedia?navigator.mediaDevices:navigator.mozGetUserMedia||navigator.webkitGetUserMedia?{getUserMedia:function(a){return new Promise(function(b,c){(navigator.mozGetUserMedia||navigator.webkitGetUserMedia).call(navigator,a,b,c)})}}:null,a.URL=a.URL||a.webkitURL||a.mozURL||a.msURL,this.userMedia=this.userMedia&&!!this.mediaDevices&&!!a.URL,navigator.userAgent.match(/Firefox\D+(\d+)/)&&parseInt(RegExp.$1,10)<21&&(this.userMedia=null),this.userMedia&&a.addEventListener("unload",function(a){b.reset()})},exifOrientation:function(a){var b=new DataView(a);if(b.getUint8(0)!=255||b.getUint8(1)!=216)return console.log("Not a valid JPEG file"),0;var c=2,d=null;while(c<a.byteLength){if(b.getUint8(c)!=255)return console.log("Not a valid marker at offset "+c+", found: "+b.getUint8(c)),0;d=b.getUint8(c+1);if(d==225){c+=4;var e="";for(n=0;n<4;n++)e+=String.fromCharCode(b.getUint8(c+n));if(e!="Exif")return console.log("Not valid EXIF data found"),0;c+=6;var f=null;if(b.getUint16(c)==18761)f=!1;else{if(b.getUint16(c)!=19789)return console.log("Not valid TIFF data! (no 0x4949 or 0x4D4D)"),0;f=!0}if(b.getUint16(c+2,!f)!=42)return console.log("Not valid TIFF data! (no 0x002A)"),0;var g=b.getUint32(c+4,!f);if(g<8)return console.log("Not valid TIFF data! (First offset less than 8)",b.getUint32(c+4,!f)),0;var h=c+g,i=b.getUint16(h,!f);for(var j=0;j<i;j++){var k=h+j*12+2;if(b.getUint16(k,!f)==274){var l=b.getUint16(k+2,!f),m=b.getUint32(k+4,!f);if(l!=3&&m!=1)return console.log("Invalid EXIF orientation value type ("+l+") or count ("+m+")"),0;var o=b.getUint16(k+8,!f);return o<1||o>8?(console.log("Invalid EXIF orientation value ("+o+")"),0):o}}}else c+=2+b.getUint16(c+2)}return 0},fixOrientation:function(a,b,c){var d=new Image;d.addEventListener("load",function(a){var e=document.createElement("canvas"),f=e.getContext("2d");b<5?(e.width=d.width,e.height=d.height):(e.width=d.height,e.height=d.width);switch(b){case 2:f.transform(-1,0,0,1,d.width,0);break;case 3:f.transform(-1,0,0,-1,d.width,d.height);break;case 4:f.transform(1,0,0,-1,0,d.height);break;case 5:f.transform(0,1,1,0,0,0);break;case 6:f.transform(0,1,-1,0,d.height,0);break;case 7:f.transform(0,-1,-1,0,d.height,d.width);break;case 8:f.transform(0,-1,1,0,0,d.width)}f.drawImage(d,0,0),c.src=e.toDataURL()},!1),d.src=a},attach:function(c){typeof c=="string"&&(c=document.getElementById(c)||document.querySelector(c));if(!c)return this.dispatch("error",new d("Could not locate DOM element to attach to."));this.container=c,c.innerHTML="";var f=document.createElement("div");c.appendChild(f),this.peg=f,this.params.width||(this.params.width=c.offsetWidth),this.params.height||(this.params.height=c.offsetHeight);if(!this.params.width||!this.params.height)return this.dispatch("error",new d("No width and/or height for webcam.  Please call set() first, or attach to a visible element."));this.params.dest_width||(this.params.dest_width=this.params.width),this.params.dest_height||(this.params.dest_height=this.params.height),this.userMedia=b===undefined?this.userMedia:b,this.params.force_flash&&(b=this.userMedia,this.userMedia=null),typeof this.params.fps!="number"&&(this.params.fps=30);var g=this.params.width/this.params.dest_width,h=this.params.height/this.params.dest_height;if(this.userMedia){var i=document.createElement("video");i.setAttribute("autoplay","autoplay"),i.style.width=""+this.params.dest_width+"px",i.style.height=""+this.params.dest_height+"px";if(g!=1||h!=1)c.style.overflow="hidden",i.style.webkitTransformOrigin="0px 0px",i.style.mozTransformOrigin="0px 0px",i.style.msTransformOrigin="0px 0px",i.style.oTransformOrigin="0px 0px",i.style.transformOrigin="0px 0px",i.style.webkitTransform="scaleX("+g+") scaleY("+h+")",i.style.mozTransform="scaleX("+g+") scaleY("+h+")",i.style.msTransform="scaleX("+g+") scaleY("+h+")",i.style.oTransform="scaleX("+g+") scaleY("+h+")",i.style.transform="scaleX("+g+") scaleY("+h+")";c.appendChild(i),this.video=i;var j=this;this.mediaDevices.getUserMedia({audio:!1,video:this.params.constraints||{mandatory:{minWidth:this.params.dest_width,minHeight:this.params.dest_height}}}).then(function(b){i.onloadedmetadata=function(a){j.stream=b,j.loaded=!0,j.live=!0,j.dispatch("load"),j.dispatch("live"),j.flip()},"srcObject"in i?i.srcObject=b:i.src=a.URL.createObjectURL(b)}).catch(function(a){j.params.enable_flash&&j.detectFlash()?setTimeout(function(){j.params.force_flash=1,j.attach(c)},1):j.dispatch("error",a)})}else if(this.iOS){var k=document.createElement("div");k.id=this.container.id+"-ios_div",k.className="webcamjs-ios-placeholder",k.style.width=""+this.params.width+"px",k.style.height=""+this.params.height+"px",k.style.textAlign="center",k.style.display="table-cell",k.style.verticalAlign="middle",k.style.backgroundRepeat="no-repeat",k.style.backgroundSize="contain",k.style.backgroundPosition="center";var l=document.createElement("span");l.className="webcamjs-ios-text",l.innerHTML=this.params.iosPlaceholderText,k.appendChild(l);var m=document.createElement("img");m.id=this.container.id+"-ios_img",m.style.width=""+this.params.dest_width+"px",m.style.height=""+this.params.dest_height+"px",m.style.display="none",k.appendChild(m);var n=document.createElement("input");n.id=this.container.id+"-ios_input",n.setAttribute("type","file"),n.setAttribute("accept","image/*"),n.setAttribute("capture","camera");var j=this,o=this.params;n.addEventListener("change",function(a){if(a.target.files.length>0&&a.target.files[0].type.indexOf("image/")==0){var b=URL.createObjectURL(a.target.files[0]),c=new Image;c.addEventListener("load",function(a){var b=document.createElement("canvas");b.width=o.dest_width,b.height=o.dest_height;var d=b.getContext("2d");ratio=Math.min(c.width/o.dest_width,c.height/o.dest_height);var e=o.dest_width*ratio,f=o.dest_height*ratio,g=(c.width-e)/2,h=(c.height-f)/2;d.drawImage(c,g,h,e,f,0,0,o.dest_width,o.dest_height);var i=b.toDataURL();m.src=i,k.style.backgroundImage="url('"+i+"')"},!1);var d=new FileReader;d.addEventListener("load",function(a){var d=j.exifOrientation(a.target.result);d>1?j.fixOrientation(b,d,c):c.src=b},!1);var e=new XMLHttpRequest;e.open("GET",b,!0),e.responseType="blob",e.onload=function(a){(this.status==200||this.status===0)&&d.readAsArrayBuffer(this.response)},e.send()}},!1),n.style.display="none",c.appendChild(n),k.addEventListener("click",function(a){o.user_callback?j.snap(o.user_callback,o.user_canvas):(n.style.display="block",n.focus(),n.click(),n.style.display="none")},!1),c.appendChild(k),this.loaded=!0,this.live=!0}else if(this.params.enable_flash&&this.detectFlash()){a.Webcam=e;var k=document.createElement("div");k.innerHTML=this.getSWFHTML(),c.appendChild(k)}else this.dispatch("error",new d(this.params.noInterfaceFoundText));if(this.params.crop_width&&this.params.crop_height){var p=Math.floor(this.params.crop_width*g),q=Math.floor(this.params.crop_height*h);c.style.width=""+p+"px",c.style.height=""+q+"px",c.style.overflow="hidden",c.scrollLeft=Math.floor(this.params.width/2-p/2),c.scrollTop=Math.floor(this.params.height/2-q/2)}else c.style.width=""+this.params.width+"px",c.style.height=""+this.params.height+"px"},reset:function(){this.preview_active&&this.unfreeze(),this.unflip();if(this.userMedia){if(this.stream)if(this.stream.getVideoTracks){var a=this.stream.getVideoTracks();a&&a[0]&&a[0].stop&&a[0].stop()}else this.stream.stop&&this.stream.stop();delete this.stream,delete this.video}if(this.userMedia!==!0&&this.loaded&&!this.iOS){var b=this.getMovie();b&&b._releaseCamera&&b._releaseCamera()}this.container&&(this.container.innerHTML="",delete this.container),this.loaded=!1,this.live=!1},set:function(){if(arguments.length==1)for(var a in arguments[0])this.params[a]=arguments[0][a];else this.params[arguments[0]]=arguments[1]},on:function(a,b){a=a.replace(/^on/i,"").toLowerCase(),this.hooks[a]||(this.hooks[a]=[]),this.hooks[a].push(b)},off:function(a,b){a=a.replace(/^on/i,"").toLowerCase();if(this.hooks[a])if(b){var c=this.hooks[a].indexOf(b);c>-1&&this.hooks[a].splice(c,1)}else this.hooks[a]=[]},dispatch:function(){var b=arguments[0].replace(/^on/i,"").toLowerCase(),e=Array.prototype.slice.call(arguments,1);if(this.hooks[b]&&this.hooks[b].length){for(var f=0,g=this.hooks[b].length;f<g;f++){var h=this.hooks[b][f];typeof h=="function"?h.apply(this,e):typeof h=="object"&&h.length==2?h[0][h[1]].apply(h[0],e):a[h]&&a[h].apply(a,e)}return!0}return b=="error"&&(e[0]instanceof c||e[0]instanceof d?message=e[0].message:message="Could not access webcam: "+e[0].name+": "+e[0].message+" "+e[0].toString(),alert("Webcam.js Error: "+message)),!1},setSWFLocation:function(a){this.set("swfURL",a)},detectFlash:function(){var b="Shockwave Flash",c="ShockwaveFlash.ShockwaveFlash",d="application/x-shockwave-flash",e=a,f=navigator,g=!1;if(typeof f.plugins!="undefined"&&typeof f.plugins[b]=="object"){var h=f.plugins[b].description;h&&typeof f.mimeTypes!="undefined"&&f.mimeTypes[d]&&f.mimeTypes[d].enabledPlugin&&(g=!0)}else if(typeof e.ActiveXObject!="undefined")try{var i=new ActiveXObject(c);if(i){var j=i.GetVariable("$version");j&&(g=!0)}}catch(k){}return g},getSWFHTML:function(){var b="",d=this.params.swfURL;if(location.protocol.match(/file/))return this.dispatch("error",new c("Flash does not work from local disk.  Please run from a web server.")),'<h3 style="color:red">ERROR: the Webcam.js Flash fallback does not work from local disk.  Please run it from a web server.</h3>';if(!this.detectFlash())return this.dispatch("error",new c("Adobe Flash Player not found.  Please install from get.adobe.com/flashplayer and try again.")),'<h3 style="color:red">'+this.params.flashNotDetectedText+"</h3>";if(!d){var e="",f=document.getElementsByTagName("script");for(var g=0,h=f.length;g<h;g++){var i=f[g].getAttribute("src");i&&i.match(/\/webcam(\.min)?\.js/)&&(e=i.replace(/\/webcam(\.min)?\.js.*$/,""),g=h)}e?d=e+"/webcam.swf":d="webcam.swf"}a.localStorage&&!localStorage.getItem("visited")&&(this.params.new_user=1,localStorage.setItem("visited",1));var j="";for(var k in this.params)j&&(j+="&"),j+=k+"="+escape(this.params[k]);return b+='<object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" type="application/x-shockwave-flash" codebase="'+this.protocol+'://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=9,0,0,0" width="'+this.params.width+'" height="'+this.params.height+'" id="webcam_movie_obj" align="middle"><param name="wmode" value="opaque" /><param name="allowScriptAccess" value="always" /><param name="allowFullScreen" value="false" /><param name="movie" value="'+d+'" /><param name="loop" value="false" /><param name="menu" value="false" /><param name="quality" value="best" /><param name="bgcolor" value="#ffffff" /><param name="flashvars" value="'+j+'"/><embed id="webcam_movie_embed" src="'+d+'" wmode="opaque" loop="false" menu="false" quality="best" bgcolor="#ffffff" width="'+this.params.width+'" height="'+this.params.height+'" name="webcam_movie_embed" align="middle" allowScriptAccess="always" allowFullScreen="false" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" flashvars="'+j+'"></embed></object>',b},getMovie:function(){if(!this.loaded)return this.dispatch("error",new c("Flash Movie is not loaded yet"));var a=document.getElementById("webcam_movie_obj");if(!a||!a._snap)a=document.getElementById("webcam_movie_embed");return a||this.dispatch("error",new c("Cannot locate Flash movie in DOM")),a},freeze:function(){var a=this,b=this.params;this.preview_active&&this.unfreeze();var c=this.params.width/this.params.dest_width,d=this.params.height/this.params.dest_height;this.unflip();var e=b.crop_width||b.dest_width,f=b.crop_height||b.dest_height,g=document.createElement("canvas");g.width=e,g.height=f;var h=g.getContext("2d");this.preview_canvas=g,this.preview_context=h;if(c!=1||d!=1)g.style.webkitTransformOrigin="0px 0px",g.style.mozTransformOrigin="0px 0px",g.style.msTransformOrigin="0px 0px",g.style.oTransformOrigin="0px 0px",g.style.transformOrigin="0px 0px",g.style.webkitTransform="scaleX("+c+") scaleY("+d+")",g.style.mozTransform="scaleX("+c+") scaleY("+d+")",g.style.msTransform="scaleX("+c+") scaleY("+d+")",g.style.oTransform="scaleX("+c+") scaleY("+d+")",g.style.transform="scaleX("+c+") scaleY("+d+")";this.snap(function(){g.style.position="relative",g.style.left=""+a.container.scrollLeft+"px",g.style.top=""+a.container.scrollTop+"px",a.container.insertBefore(g,a.peg),a.container.style.overflow="hidden",a.preview_active=!0},g)},unfreeze:function(){this.preview_active&&(this.container.removeChild(this.preview_canvas),delete this.preview_context,delete this.preview_canvas,this.preview_active=!1,this.flip())},flip:function(){if(this.params.flip_horiz){var a=this.container.style;a.webkitTransform="scaleX(-1)",a.mozTransform="scaleX(-1)",a.msTransform="scaleX(-1)",a.oTransform="scaleX(-1)",a.transform="scaleX(-1)",a.filter="FlipH",a.msFilter="FlipH"}},unflip:function(){if(this.params.flip_horiz){var a=this.container.style;a.webkitTransform="scaleX(1)",a.mozTransform="scaleX(1)",a.msTransform="scaleX(1)",a.oTransform="scaleX(1)",a.transform="scaleX(1)",a.filter="",a.msFilter=""}},savePreview:function(a,b){var c=this.params,d=this.preview_canvas,e=this.preview_context;if(b){var f=b.getContext("2d");f.drawImage(d,0,0)}a(b?null:d.toDataURL("image/"+c.image_format,c.jpeg_quality/100),d,e),this.params.unfreeze_snap&&this.unfreeze()},snap:function(a,b){a||(a=this.params.user_callback),b||(b=this.params.user_canvas);var c=this,e=this.params;if(!this.loaded)return this.dispatch("error",new d("Webcam is not loaded yet"));if(!a)return this.dispatch("error",new d("Please provide a callback function or canvas to snap()"));if(this.preview_active)return this.savePreview(a,b),null;var f=document.createElement("canvas");f.width=this.params.dest_width,f.height=this.params.dest_height;var g=f.getContext("2d");this.params.flip_horiz&&(g.translate(e.dest_width,0),g.scale(-1,1));var h=function(){this.src&&this.width&&this.height&&g.drawImage(this,0,0,e.dest_width,e.dest_height);if(e.crop_width&&e.crop_height){var c=document.createElement("canvas");c.width=e.crop_width,c.height=e.crop_height;var d=c.getContext("2d");d.drawImage(f,Math.floor(e.dest_width/2-e.crop_width/2),Math.floor(e.dest_height/2-e.crop_height/2),e.crop_width,e.crop_height,0,0,e.crop_width,e.crop_height),g=d,f=c}if(b){var h=b.getContext("2d");h.drawImage(f,0,0)}a(b?null:f.toDataURL("image/"+e.image_format,e.jpeg_quality/100),f,g)};if(this.userMedia)g.drawImage(this.video,0,0,this.params.dest_width,this.params.dest_height),h();else if(this.iOS){var i=document.getElementById(this.container.id+"-ios_div"),j=document.getElementById(this.container.id+"-ios_img"),k=document.getElementById(this.container.id+"-ios_input");iFunc=function(a){h.call(j),j.removeEventListener("load",iFunc),i.style.backgroundImage="none",j.removeAttribute("src"),k.value=null},k.value?iFunc(null):(j.addEventListener("load",iFunc),k.style.display="block",k.focus(),k.click(),k.style.display="none")}else{var l=this.getMovie()._snap(),j=new Image;j.onload=h,j.src="data:image/"+this.params.image_format+";base64,"+l}return null},configure:function(a){a||(a="camera"),this.getMovie()._configure(a)},flashNotify:function(a,b){switch(a){case"flashLoadComplete":this.loaded=!0,this.dispatch("load");break;case"cameraLive":this.live=!0,this.dispatch("live");break;case"error":this.dispatch("error",new c(b));break;default:}},b64ToUint6:function(a){return a>64&&a<91?a-65:a>96&&a<123?a-71:a>47&&a<58?a+4:a===43?62:a===47?63:0},base64DecToArr:function(a,b){var c=a.replace(/[^A-Za-z0-9\+\/]/g,""),d=c.length,e=b?Math.ceil((d*3+1>>2)/b)*b:d*3+1>>2,f=new Uint8Array(e);for(var g,h,i=0,j=0,k=0;k<d;k++){h=k&3,i|=this.b64ToUint6(c.charCodeAt(k))<<18-6*h;if(h===3||d-k===1){for(g=0;g<3&&j<e;g++,j++)f[j]=i>>>(16>>>g&24)&255;i=0}}return f},upload:function(a,b,c){var d=this.params.upload_name||"webcam",f="";if(!a.match(/^data\:image\/(\w+)/))throw"Cannot locate image format in Data URI";f=RegExp.$1;var g=a.replace(/^data\:image\/\w+\;base64\,/,""),h=new XMLHttpRequest;h.open("POST",b,!0),h.upload&&h.upload.addEventListener&&h.upload.addEventListener("progress",function(a){if(a.lengthComputable){var b=a.loaded/a.total;e.dispatch("uploadProgress",b,a)}},!1);var i=this;h.onload=function(){c&&c.apply(i,[h.status,h.responseText,h.statusText]),e.dispatch("uploadComplete",h.status,h.responseText,h.statusText)};var j=new Blob([this.base64DecToArr(g)],{type:"image/"+f}),k=new FormData;k.append(d,j,d+"."+f.replace(/e/,"")),h.send(k)}};e.init(),typeof define=="function"&&define.amd?define(function(){return e}):typeof module=="object"&&module.exports?module.exports=e:a.Webcam=e})(window);